name: Build & Release Solvionyx OS Editions

on:
  workflow_dispatch:     # Manual trigger
  push:                  # Trigger on main branch updates
    branches: [ main ]
  schedule:              # Nightly rebuild at 03:00 UTC
    - cron: "0 3 * * *"

permissions:
  contents: write

env:
  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

jobs:
  build:
    name: Aurora (${{ matrix.desktop }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        desktop: [gnome, xfce, kde]

    steps:
      - uses: actions/checkout@v4
  publish:
    runs-on: ubuntu-latest
    needs: [ build ]
    if: always()
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: release
          pattern: Solvionyx-OS-v4.*
          merge-multiple: true

      - name: Prepare checksums
        run: |
          cd release || exit 0
          if ls *.iso >/dev/null 2>&1; then sha256sum *.iso > SHA256SUMS.txt; fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          fail_on_unmatched_files: false
          tag_name: Aurora-v4.3.9
          name: "Solvionyx OS Aurora v4.3.9 – GNOME / XFCE / KDE"
          body: |
            ✅ **Solvionyx OS Aurora v4.3.9** successfully built and released!
            This release includes:
            - GNOME, XFCE, and KDE editions
            - Updated builder reliability and permissions fix
            - Auto checksum generation
          files: |
            release/*.iso
            release/SHA256SUMS.txt

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-utils xorriso squashfs-tools genisoimage wget curl rsync debootstrap

      # ✅ Run builder under *bash* even with sudo; pass DESKTOP via env
      - name: Build ${{ matrix.desktop }}
        shell: bash
        env:
          DESKTOP: ${{ matrix.desktop }}
        run: |
          chmod +x build_iso_debian.sh
          sudo bash build_iso_debian.sh

      # Upload whatever builds, even if other editions fail later
      - name: Upload ISO artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Solvionyx-OS-v4.3.8-${{ matrix.desktop }}
          path: iso_output/*.iso

  release:
    name: Publish Release (Partial OK)
    runs-on: ubuntu-latest
    needs: [ build ]
    if: always()
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: release/
          pattern: Solvionyx-OS-v4.3.8-*
          merge-multiple: true

      - name: Prepare checksums
        run: |
          cd release || exit 0
          if ls *.iso >/dev/null 2>&1; then sha256sum *.iso > SHA256SUMS.txt; fi
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        continue-on-error: true
        env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          fail_on_unmatched_files: false
          tag_name: Aurora-v4.3.8
          name: "Solvionyx OS Aurora v4.3.8 – GNOME/XFCE/KDE"
          body: |
            ✅ Fixed build pipeline
            ✅ Smart ISO auto-detection with Debian/Ubuntu fallback
            ✅ Includes Aurora GNOME, XFCE, and KDE editions
          files: |
            iso_output/*.iso
            SHA256SUMS.txt

            release/*.iso
            release/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
