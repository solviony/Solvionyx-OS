name: Build & Release Solvionyx OS — Aurora Series (GCS Edition)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write  # Needed for GitHub Releases

jobs:
  build:
    name: 🧠 Solvionyx OS — Aurora (${{ matrix.edition }})
    runs-on: ubuntu-24.04
    timeout-minutes: 150

    strategy:
      matrix:
        edition: [gnome, xfce, kde]
      fail-fast: false

    steps:
    # ---------------------------------------------------
    # 1. Checkout Repository
    # ---------------------------------------------------
    - name: 🧩 Checkout repository
      uses: actions/checkout@v4

    # ---------------------------------------------------
    # 2. Install Dependencies
    # ---------------------------------------------------
    - name: ⚙️ Install base tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debootstrap grub-pc-bin grub-efi-amd64-bin grub-common \
          syslinux isolinux syslinux-utils mtools xorriso squashfs-tools \
          rsync systemd-container genisoimage dosfstools xz-utils jq curl unzip \
          plymouth plymouth-themes plymouth-label python3-pip

    # ---------------------------------------------------
    # 3. Authenticate with Google Cloud
    # ---------------------------------------------------
    - name: ☁️ Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCS_CREDENTIALS_JSON }}

    - name: ⚙️ Setup gcloud and gsutil
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        install_components: gsutil

    - name: 🔍 Verify GCS Access
      run: |
        echo "🔍 Checking GCS bucket access..."
        gsutil ls gs://solvionyx-os || echo "⚠️ Bucket list failed (check permissions)"
        gcloud auth list

    # ---------------------------------------------------
    # 4. Run Build Script
    # ---------------------------------------------------
    - name: 💿 Build Solvionyx OS ISO (${{ matrix.edition }})
      run: |
        chmod +x build_iso_debian.sh
        sudo ./build_iso_debian.sh ${{ matrix.edition }}

    # ---------------------------------------------------
    # 5. Verify Uploads on GCS
    # ---------------------------------------------------
    - name: ☁️ Verify uploaded files on GCS
      run: |
        echo "🔍 Verifying uploaded edition ${{ matrix.edition }}..."
        gsutil ls gs://solvionyx-os/aurora/latest/${{ matrix.edition }}/ || echo "⚠️ Upload check failed"

    # ---------------------------------------------------
    # 6. Publish GitHub Release
    # ---------------------------------------------------
    - name: 🚀 Publish GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: Aurora-v${{ github.run_number }}
        name: "Solvionyx OS Aurora (${{ matrix.edition }}) v${{ github.run_number }}"
        body: |
          ## 🧠 Solvionyx OS Aurora
          *The Engine Behind the Vision.*

          ✅ Edition: ${{ matrix.edition }}  
          ✅ Solvionyx Boot Branding (Logo + Splash)  
          ✅ Bootable (UEFI + BIOS)  
          ✅ Uploaded to GCS  

          🌐 **GCS Download:**  
          https://storage.googleapis.com/solvionyx-os/aurora/latest/${{ matrix.edition }}/
          
    # ---------------------------------------------------
    # 7. Build Summary
    # ---------------------------------------------------
    - name: 📋 Post Build Summary
      run: |
        echo "🧾 Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "✅ Edition: ${{ matrix.edition }}" >> $GITHUB_STEP_SUMMARY
        echo "✅ Bootable & Branded" >> $GITHUB_STEP_SUMMARY
        echo "✅ Uploaded to GCS bucket: solvionyx-os" >> $GITHUB_STEP_SUMMARY
        echo "🌍 https://storage.googleapis.com/solvionyx-os/aurora/latest/${{ matrix.edition }}/" >> $GITHUB_STEP_SUMMARY
