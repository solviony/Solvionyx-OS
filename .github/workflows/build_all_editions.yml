name: Build & Release Solvionyx OS — Aurora Series (All Editions)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write  # Needed for GitHub Releases

jobs:
  build:
    name: 🧠 Solvionyx OS — Aurora (${{ matrix.edition }})
    runs-on: ubuntu-24.04
    timeout-minutes: 120

    strategy:
      matrix:
        edition: [gnome, xfce, kde]
      fail-fast: false

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      S3_BUCKET: solvionyx-releases

    steps:
    # ---------------------------------------------------
    # 1. Checkout Repository
    # ---------------------------------------------------
    - name: 🧩 Checkout repository
      uses: actions/checkout@v4

    # ---------------------------------------------------
    # 2. Clean Workspace
    # ---------------------------------------------------
    - name: 🧹 Clean workspace
      run: |
        echo "🧹 Cleaning previous build..."
        sudo rm -rf solvionyx_build || true
        echo "✅ Workspace ready."

    # ---------------------------------------------------
    # 3. Install Dependencies
    # ---------------------------------------------------
    - name: ⚙️ Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debootstrap grub-pc-bin grub-efi-amd64-bin grub-common \
          syslinux isolinux syslinux-utils mtools xorriso squashfs-tools \
          rsync systemd-container genisoimage dosfstools xz-utils jq curl unzip \
          plymouth plymouth-themes plymouth-label python3-pip

        echo "☁️ Checking AWS CLI..."
        if ! command -v aws &> /dev/null; then
          curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -qq awscliv2.zip
          sudo ./aws/install
        fi
        echo "✅ Dependencies installed and ready."

    # ---------------------------------------------------
    # 4. Run Solvionyx ISO Builder
    # ---------------------------------------------------
    - name: 💿 Run Solvionyx ISO Builder (${{ matrix.edition }})
      run: |
        chmod +x build_iso_debian.sh
        echo "🚀 Building Solvionyx Aurora for edition: ${{ matrix.edition }}"
        sudo ./build_iso_debian.sh ${{ matrix.edition }}

    # ---------------------------------------------------
    # 5. Verify ISO Existence
    # ---------------------------------------------------
    - name: 🔍 Verify ISO existence
      run: |
        echo "🔍 Checking for ISO file..."
        ISO_PATH=$(find solvionyx_build -type f -name "*.iso*" | head -n 1)
        if [ -z "$ISO_PATH" ]; then
          echo "❌ No ISO found!"
          exit 1
        else
          echo "✅ Found ISO: $ISO_PATH"
        fi

    # ---------------------------------------------------
    # 6. Compress ISO
    # ---------------------------------------------------
    - name: 🗜️ Compress Solvionyx ISO
      run: |
        echo "🗜️ Compressing ISO..."
        cd solvionyx_build
        ISO_FILE=$(find . -type f -name "*.iso" | head -n 1)
        if [ -f "$ISO_FILE" ]; then
          echo "Compressing with limited threads..."
          xz -T2 -5 "$ISO_FILE"
          echo "✅ Compression complete."
        else
          echo "⚠️ No raw ISO to compress — skipping."
        fi

    # ---------------------------------------------------
    # 7. Generate SHA256 Checksums
    # ---------------------------------------------------
    - name: 🔐 Generate SHA256 checksums
      run: |
        cd solvionyx_build
        echo "🔐 Generating checksums..."
        sha256sum *.iso.xz > SHA256SUMS.txt
        cat SHA256SUMS.txt

    # ---------------------------------------------------
    # 8. Verify Bootable ISO Structure
    # ---------------------------------------------------
    - name: 🧩 Verify Bootable ISO Structure
      run: |
        echo "🧩 Verifying bootable components..."
        ISO_FILE=$(find solvionyx_build -name "*.iso.xz" | head -n 1)
        xz -d -k "$ISO_FILE"
        RAW_ISO="${ISO_FILE%.xz}"
        mkdir -p mnt
        sudo mount -o loop "$RAW_ISO" mnt

        if [ ! -f mnt/boot/vmlinuz-* ]; then
          echo "❌ Missing kernel (vmlinuz) file!"
          sudo umount mnt
          exit 1
        fi

        if [ ! -f mnt/EFI/BOOT/BOOTX64.EFI ]; then
          echo "❌ Missing EFI bootloader!"
          sudo umount mnt
          exit 1
        fi

        echo "✅ ISO contains valid EFI + kernel boot structure."
        sudo umount mnt

    # ---------------------------------------------------
    # 9. Validate AWS Credentials Early
    # ---------------------------------------------------
    - name: 🔍 Validate AWS setup
      run: |
        echo "🔍 Validating AWS credentials..."
        aws sts get-caller-identity || { echo "❌ AWS credentials invalid or missing!"; exit 1; }
        echo "✅ AWS credentials confirmed."
        echo "🌍 Checking S3 bucket access..."
        aws s3 ls s3://$S3_BUCKET || { echo "❌ Cannot access S3 bucket $S3_BUCKET"; exit 1; }
        echo "✅ S3 access verified."

    # ---------------------------------------------------
    # 10. Upload to AWS S3 (Unified Aurora structure)
    # ---------------------------------------------------
    - name: ☁️ Upload to AWS S3 (Aurora unified structure)
      run: |
        VERSION="v${{ github.run_number }}"
        ISO_DIR="solvionyx_build"
        REGION="$AWS_DEFAULT_REGION"
        BUCKET_URL="https://$S3_BUCKET.s3.${REGION}.amazonaws.com"
        EDITION="${{ matrix.edition }}"
        RELEASE_PATH="aurora/${VERSION}/${EDITION}"
        LATEST_PATH="aurora/latest/${EDITION}"

        ISO_FILE=$(ls ${ISO_DIR}/*.iso.xz | head -n 1)
        SHA256_FILE="${ISO_DIR}/SHA256SUMS.txt"

        echo "☁️ Uploading Solvionyx ${EDITION} ISO..."
        aws s3 cp "$ISO_FILE" "s3://${S3_BUCKET}/${RELEASE_PATH}/" --acl public-read
        aws s3 cp "$SHA256_FILE" "s3://${S3_BUCKET}/${RELEASE_PATH}/" --acl public-read

        echo "☁️ Updating latest..."
        aws s3 cp "$ISO_FILE" "s3://${S3_BUCKET}/${LATEST_PATH}/" --acl public-read
        aws s3 cp "$SHA256_FILE" "s3://${S3_BUCKET}/${LATEST_PATH}/" --acl public-read

        echo "✅ Upload complete for ${EDITION} edition."

        # Create metadata file
        ISO_NAME=$(basename "$ISO_FILE")
        SHA256_HASH=$(sha256sum "$ISO_FILE" | awk '{print $1}')
        DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        cat > latest.json <<EOF
        {
          "version": "${VERSION}",
          "edition": "${EDITION}",
          "release_name": "Solvionyx OS Aurora (${EDITION} Edition)",
          "tagline": "The engine behind the vision.",
          "brand": "Solvionyx OS",
          "build_date": "${DATE}",
          "iso_name": "${ISO_NAME}",
          "sha256": "${SHA256_HASH}",
          "download_url": "${BUCKET_URL}/aurora/latest/${EDITION}/${ISO_NAME}",
          "checksum_url": "${BUCKET_URL}/aurora/latest/${EDITION}/SHA256SUMS.txt"
        }
        EOF

        aws s3 cp latest.json "s3://${S3_BUCKET}/${LATEST_PATH}/latest.json" --acl public-read
        echo "✅ Metadata uploaded successfully."

    # ---------------------------------------------------
    # 11. Publish GitHub Release
    # ---------------------------------------------------
    - name: 🚀 Publish GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: Aurora-v${{ github.run_number }}
        name: "Solvionyx OS Aurora (${{ matrix.edition }}) v${{ github.run_number }}"
        body: |
          ## 🧠 Solvionyx OS Aurora
          *The Engine Behind the Vision.*

          ✅ ${{ matrix.edition }} desktop  
          ✅ Calamares installer  
          ✅ Solvionyx branding  
          ✅ Bootable & Live-ready  

          🌐 **AWS S3 (Unified Bucket):**  
          https://solvionyx-releases.s3.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com/aurora/latest/

    # ---------------------------------------------------
    # 12. Build Summary
    # ---------------------------------------------------
    - name: 📋 Post Build Summary
      run: |
        echo "🧾 Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "✅ Edition: ${{ matrix.edition }}" >> $GITHUB_STEP_SUMMARY
        echo "✅ Verified bootable (EFI + Kernel)" >> $GITHUB_STEP_SUMMARY
        echo "✅ Uploaded to S3 bucket: $S3_BUCKET" >> $GITHUB_STEP_SUMMARY
        echo "🌍 Region: $AWS_DEFAULT_REGION" >> $GITHUB_STEP_SUMMARY
        echo "🌐 Public URL: https://$S3_BUCKET.s3.${AWS_DEFAULT_REGION}.amazonaws.com/aurora/latest/" >> $GITHUB_STEP_SUMMARY
