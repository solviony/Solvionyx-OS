name: Build & Release Solvionyx OS â€” Aurora v6 Ultra

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  build:
    name: ðŸ§  Solvionyx OS v6 Ultra â€” ${{ matrix.edition }}
    runs-on: ubuntu-24.04
    timeout-minutes: 180

    strategy:
      matrix:
        edition: [gnome, xfce, kde]
      fail-fast: false

    env:
      OS_NAME: "Solvionyx OS"
      OS_FLAVOR: "Aurora"
      TAGLINE: "The Engine Behind the Vision."
      VERSION: v${{ github.run_number }}

      ISO_DIR: solvionyx_build
      BRAND_LOGO: branding/logo/solvionyx-logo.png
      BRAND_BG: branding/wallpapers/aurora-bg.jpg

      SECUREBOOT_DIR: secureboot
      SBAT_URL: "https://solviony.com/security/"

      GCS_BUCKET: solvionyx-os
      GCP_PROJECT: iconic-biplane-476304-u8

    steps:

    # ---------------------------------------------------------
    - name: ðŸ§© Checkout Repository
      uses: actions/checkout@v4

    # ---------------------------------------------------------
    - name: âš™ï¸ Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debootstrap grub-pc-bin grub-efi-amd64-bin grub-common \
          syslinux isolinux syslinux-utils mtools xorriso squashfs-tools \
          rsync systemd-container genisoimage dosfstools xz-utils jq curl unzip \
          plymouth plymouth-themes plymouth-label imagemagick \
          sbsigntool efitools openssl shim-signed mokutil

    # --------------------------------------------------------
    # ðŸ” SecureBoot â€” Generate PK / KEK / DB Keys + SBAT
    # --------------------------------------------------------
    - name: ðŸ” Generate SecureBoot Keys
      run: |
        mkdir -p $SECUREBOOT_DIR/sbat $SECUREBOOT_DIR/output

        echo "ðŸ”‘ Generating SecureBoot PK/KEK/DB..."

        # Platform Key (PK)
        openssl req -new -x509 -newkey rsa:4096 -nodes \
          -keyout $SECUREBOOT_DIR/pk.key \
          -out $SECUREBOOT_DIR/pk.crt \
          -days 3650 \
          -subj "/C=US/ST=Missouri/L=Columbia/O=Solviony Inc/OU=Solvionyx OS Security/CN=Solvionyx OS Platform Key/emailAddress=dev@solviony.com"

        # Key Exchange Key (KEK)
        openssl req -new -x509 -newkey rsa:4096 -nodes \
          -keyout $SECUREBOOT_DIR/kek.key \
          -out $SECUREBOOT_DIR/kek.crt \
          -days 3650 \
          -subj "/C=US/ST=Missouri/L=Columbia/O=Solviony Inc/OU=Solvionyx OS Security/CN=Solvionyx OS KEK/emailAddress=dev@solviony.com"

        # Signature Database Key (DB)
        openssl req -new -x509 -newkey rsa:4096 -nodes \
          -keyout $SECUREBOOT_DIR/db.key \
          -out $SECUREBOOT_DIR/db.crt \
          -days 3650 \
          -subj "/C=US/ST=Missouri/L=Columbia/O=Solviony Inc/OU=Solvionyx OS Security/CN=Solvionyx OS DB/emailAddress=dev@solviony.com"

        echo "ðŸ”§ Writing SBAT metadata..."
        cat > $SECUREBOOT_DIR/sbat/sbat.csv <<EOF
sbat,1,Solviony,Solvionyx-OS,1,${SBAT_URL}
EOF

        echo "âœ… SecureBoot Keys + SBAT ready."


    # --------------------------------------------------------
    # ðŸ”½ Extract shim & GRUB EFI from system
    # --------------------------------------------------------
    - name: ðŸ“¦ Extract shim + GRUB EFI binaries
      run: |
        mkdir -p efi-bin

        echo "ðŸ“¥ Extracting shim..."
        cp /usr/lib/shim/shimx64.efi.signed efi-bin/bootx64.efi || true
        cp /usr/lib/shim/mmx64.efi efi-bin/ || true

        echo "ðŸ“¥ Extracting GRUB EFI (signed)..."
        cp /usr/lib/grub/x86_64-efi-signed/grubx64.efi.signed efi-bin/grubx64.efi || true

        echo "EFI binaries extracted:"
        ls -lh efi-bin/

    # ---------------------------------------------------------
    - name: ðŸ” Generate SecureBoot Keys
      run: |
        mkdir -p $SECUREBOOT_DIR/sbat $SECUREBOOT_DIR/output

        echo "ðŸ”‘ Generating PK, KEK, DB..."
        openssl req -new -x509 -newkey rsa:4096 -nodes \
          -keyout $SECUREBOOT_DIR/pk.key \
          -out $SECUREBOOT_DIR/pk.crt \
          -days 3650 \
          -subj "/C=US/ST=Missouri/L=Columbia/O=Solviony Inc/OU=Solvionyx OS Security/CN=Solvionyx OS PK/emailAddress=dev@solviony.com"

        openssl req -new -x509 -newkey rsa:4096 -nodes \
          -keyout $SECUREBOOT_DIR/kek.key \
          -out $SECUREBOOT_DIR/kek.crt \
          -days 3650 \
          -subj "/C=US/ST=Missouri/L=Columbia/O=Solviony Inc/OU=Solvionyx OS Security/CN=Solvionyx OS KEK/emailAddress=dev@solviony.com"

        openssl req -new -x509 -newkey rsa:4096 -nodes \
          -keyout $SECUREBOOT_DIR/db.key \
          -out $SECUREBOOT_DIR/db.crt \
          -days 3650 \
          -subj "/C=US/ST=Missouri/L=Columbia/O=Solviony Inc/OU=Solvionyx OS Security/CN=Solvionyx OS DB/emailAddress=dev@solviony.com"

        echo "sbat,1,Solviony,Solvionyx-OS,1,${SBAT_URL}" \
          > $SECUREBOOT_DIR/sbat/grub-sbat.txt

        echo "sbat,1,Solviony,Solvionyx-OS,1,${SBAT_URL}" \
          > $SECUREBOOT_DIR/sbat/kernel-sbat.txt

    # ---------------------------------------------------------
    - name: ðŸ”½ Extract Shim + Signed GRUB from System
      run: |
        mkdir -p efi-bin

        cp /usr/lib/shim/shimx64.efi.signed efi-bin/bootx64.efi
        cp /usr/lib/shim/mmx64.efi efi-bin/
        cp /usr/lib/grub/x86_64-efi-signed/grubx64.efi.signed efi-bin/grubx64.efi

        echo "Extracted:"
        ls -lh efi-bin/

    # ---------------------------------------------------------
    - name: ðŸŽ¨ Ensure Branding Exists
      run: |
        if [ ! -f "${BRAND_LOGO}" ]; then
          convert -size 512x128 xc:'#0b1220' -gravity center \
              -fill '#6f3bff' -pointsize 48 \
              -annotate 0 'SOLVIONYX' "${BRAND_LOGO}"
        fi

    # ---------------------------------------------------------
    - name: ðŸ’¿ Build Unsigned ISO
      run: |
        chmod +x build/builder_v6_ultra.sh
        ./build/builder_v6_ultra.sh "${{ matrix.edition }}"

    # ---------------------------------------------------------
    - name: ðŸ” SecureBoot â€” Sign Kernel + GRUB
      run: |
        UNSIGNED=$(ls solvionyx_build/*.iso | head -n 1)
        mkdir -p signed-iso

        echo "ðŸ“¦ Extracting ISO..."
        xorriso -osirrox on -indev "$UNSIGNED" -extract / signed-iso/

        echo "ðŸ” Signing GRUB..."
        sbsign --key $SECUREBOOT_DIR/db.key \
               --cert $SECUREBOOT_DIR/db.crt \
               --output signed-iso/EFI/ubuntu/grubx64.efi \
               efi-bin/grubx64.efi

        echo "ðŸ” Patching SBAT..."
        cp $SECUREBOOT_DIR/sbat/grub-sbat.txt signed-iso/boot/grub/grubx64.efi.sbat

        echo "ðŸ” Signing Kernel..."
        KERNEL=$(find signed-iso/live -name "vmlinuz*" | head -n 1)
        sbsign --key $SECUREBOOT_DIR/db.key --cert $SECUREBOOT_DIR/db.crt \
               --output "${KERNEL}.signed" "$KERNEL"
        mv "${KERNEL}.signed" "$KERNEL"

        echo "ðŸ“¦ Inserting shim..."
        mkdir -p signed-iso/EFI/boot
        cp efi-bin/bootx64.efi signed-iso/EFI/boot/
        cp efi-bin/mmx64.efi signed-iso/EFI/boot/

        echo "ðŸ”„ Rebuilding SecureBoot ISO..."
        xorriso -as mkisofs \
          -o solvionyx_build/SecureBoot-${{ matrix.edition }}-${{ env.VERSION }}.iso \
          -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
          -c isolinux/boot.cat \
          -b isolinux/isolinux.bin \
          -no-emul-boot -boot-load-size 4 -boot-info-table \
          -eltorito-alt-boot \
          -e boot/grub/efi.img -no-emul-boot -isohybrid-gpt-basdat \
          signed-iso/
    # --------------------------------------------------------
    # ðŸ’¿ Build Unsigned Aurora ISO
    # --------------------------------------------------------
    - name: ðŸ’¿ Build Unsigned Solvionyx OS ISO
      run: |
        echo "ðŸš€ Building unsigned Aurora ISO for edition: ${{ matrix.edition }}"
        chmod +x build/builder_v6_ultra.sh
        ./build/builder_v6_ultra.sh "${{ matrix.edition }}"

        echo "ðŸ“¦ ISO build complete."
        ls -lh solvionyx_build/


    # --------------------------------------------------------
    # ðŸ” SecureBoot â€” Sign GRUB + Kernel
    # --------------------------------------------------------
    - name: ðŸ” SecureBoot â€” Sign GRUB + Kernel
      run: |
        echo "ðŸ”Ž Locating ISO..."
        UNSIGNED_ISO=$(ls solvionyx_build/*.iso | head -n 1)
        echo "Found unsigned ISO: $UNSIGNED_ISO"

        echo "ðŸ“¦ Extracting ISO filesystem..."
        mkdir -p iso_extract
        xorriso -osirrox on -indev "$UNSIGNED_ISO" -extract / iso_extract/

        echo "ðŸ” Applying SBAT metadata to GRUB..."
        if [ -f iso_extract/boot/grub/grubx64.efi ]; then
          cp $SECUREBOOT_DIR/sbat/sbat.csv iso_extract/boot/grub/grubx64.efi.sbat
        fi

        echo "ðŸ“ Signing GRUB EFI using Solvionyx DB key..."
        sbsign \
          --key $SECUREBOOT_DIR/db.key \
          --cert $SECUREBOOT_DIR/db.crt \
          --output iso_extract/EFI/ubuntu/grubx64.efi \
          efi-bin/grubx64.efi

        echo "ðŸ“ Signing Linux Kernel..."
        KERNEL=$(find iso_extract/live -name "vmlinuz*" | head -n 1)
        sbsign \
          --key $SECUREBOOT_DIR/db.key \
          --cert $SECUREBOOT_DIR/db.crt \
          --output "${KERNEL}.signed" \
          "$KERNEL"

        mv "${KERNEL}.signed" "$KERNEL"


    # --------------------------------------------------------
    # ðŸ” Reinsertion of SHIM + MM + final EFI layout
    # --------------------------------------------------------
    - name: ðŸ” Insert SHIM + MM into ISO
      run: |
        echo "ðŸ“¥ Reinserting SHIM into ISO..."
        mkdir -p iso_extract/EFI/boot/

        cp efi-bin/bootx64.efi iso_extract/EFI/boot/
        cp efi-bin/mmx64.efi iso_extract/EFI/boot/

        echo "EFI bootloader components now in place."


    # --------------------------------------------------------
    # ðŸ“¦ Rebuild SecureBoot-enabled ISO
    # --------------------------------------------------------
    - name: ðŸ“¦ Repack SecureBoot-enabled ISO
      run: |
        SECUREBOOT_ISO="solvionyx_build/Solvionyx-Aurora-v6-${{ matrix.edition }}-secureboot.iso"

        echo "ðŸ”„ Rebuilding ISO with SecureBoot..."
        xorriso -as mkisofs \
          -o "$SECUREBOOT_ISO" \
          -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
          -c isolinux/boot.cat \
          -b isolinux/isolinux.bin \
          -no-emul-boot -boot-load-size 4 -boot-info-table \
          -eltorito-alt-boot \
          -e boot/grub/efi.img \
          -no-emul-boot -isohybrid-gpt-basdat \
          iso_extract/

        echo "ðŸŽ‰ SecureBoot ISO created:"
        ls -lh "$SECUREBOOT_ISO"

    # ---------------------------------------------------------
    - name: ðŸ—œï¸ Compress ISO + Generate Checksums
      run: |
        xz -T2 -9 solvionyx_build/*.iso
        sha256sum solvionyx_build/*.xz > solvionyx_build/SHA256SUMS.txt
    # --------------------------------------------------------
    # ðŸ—œï¸ Compress SecureBoot ISO + Generate SHA256SUMS
    # --------------------------------------------------------
    - name: ðŸ—œï¸ Compress SecureBoot ISO + Checksum
      run: |
        echo "ðŸ” Finding SecureBoot ISO..."
        SECUREBOOT_ISO=$(ls solvionyx_build/*secureboot.iso | head -n 1)
        echo "Found: $SECUREBOOT_ISO"

        echo "ðŸ—œï¸ Compressing ISO..."
        xz -T2 -9 "$SECUREBOOT_ISO"

        echo "ðŸ” Generating SHA256SUMS..."
        sha256sum solvionyx_build/*.xz > solvionyx_build/SHA256SUMS.txt

        echo "Checksums:"
        cat solvionyx_build/SHA256SUMS.txt


    # --------------------------------------------------------
    # â˜ï¸ Upload to Google Cloud Storage (Auto-Public)
    # --------------------------------------------------------
    - name: â˜ï¸ Upload SecureBoot ISO to Google Cloud Storage
      env:
        EDITION: ${{ matrix.edition }}
      run: |
        echo "ðŸ“¤ Uploading to GCS bucket: ${GCS_BUCKET}"

        VERSION_PATH="aurora/${VERSION}/${EDITION}"
        LATEST_PATH="aurora/latest/${EDITION}"

        gsutil -m cp solvionyx_build/*.xz solvionyx_build/SHA256SUMS.txt \
          gs://${GCS_BUCKET}/${VERSION_PATH}/

        gsutil -m cp solvionyx_build/*.xz solvionyx_build/SHA256SUMS.txt \
          gs://${GCS_BUCKET}/${LATEST_PATH}/

        echo "ðŸŒ Setting public access..."
        gsutil acl ch -u AllUsers:R gs://${GCS_BUCKET}/${VERSION_PATH}/*
        gsutil acl ch -u AllUsers:R gs://${GCS_BUCKET}/${LATEST_PATH}/*

        echo "ðŸ“¡ Writing latest.json metadata..."
        ISO_NAME=$(basename $(ls solvionyx_build/*.xz | head -n 1))
        SHA256=$(awk '{print $1}' solvionyx_build/SHA256SUMS.txt)
        DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        cat > latest.json <<EOF
        {
          "version": "${VERSION}",
          "edition": "${EDITION}",
          "release_name": "${OS_NAME} ${OS_FLAVOR} (${EDITION})",
          "tagline": "${TAGLINE}",
          "sha256": "${SHA256}",
          "iso_name": "${ISO_NAME}",
          "download_url": "https://storage.googleapis.com/${GCS_BUCKET}/${LATEST_PATH}/${ISO_NAME}",
          "checksum_url": "https://storage.googleapis.com/${GCS_BUCKET}/${LATEST_PATH}/SHA256SUMS.txt",
          "updated": "${DATE}"
        }
        EOF

        gsutil cp latest.json gs://${GCS_BUCKET}/${LATEST_PATH}/
        gsutil acl ch -u AllUsers:R gs://${GCS_BUCKET}/${LATEST_PATH}/latest.json

        echo "ðŸŒŸ Upload complete!"


    # --------------------------------------------------------
    # ðŸ“¦ Upload ISO + Checksums to GitHub Artifacts
    # --------------------------------------------------------
    - name: ðŸ“¦ Upload ISO Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Solvionyx-Aurora-v6-${{ matrix.edition }}-${{ env.VERSION }}
        path: |
          solvionyx_build/*.xz
          solvionyx_build/SHA256SUMS.txt


    # --------------------------------------------------------
    # ðŸš€ Publish GitHub Release
    # --------------------------------------------------------
    - name: ðŸš€ Publish Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "Aurora-v6-${{ matrix.edition }}-${{ env.VERSION }}"
        name: "Solvionyx OS â€” Aurora v6 Ultra (${ { matrix.edition } })"
        body: |
          ## ðŸŒŒ Solvionyx OS â€” Aurora v6 Ultra
          **Edition:** ${{ matrix.edition }}
          **SecureBoot:** Fully Signed (Shim + GRUB + Kernel)
          **Branding:** Aurora UI v6
          **Checksum:** SHA256 included

          **Download Latest:**
          https://storage.googleapis.com/${{ env.GCS_BUCKET }}/aurora/latest/${{ matrix.edition }}/

          **Google Cloud Versioned Build:**
          https://storage.googleapis.com/${{ env.GCS_BUCKET }}/aurora/${{ env.VERSION }}/${{ matrix.edition }}/
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ---------------------------------------------------------
    - name: â˜ï¸ Upload to Google Cloud Storage
      env:
        EDITION: ${{ matrix.edition }}
      run: |
        gsutil -m cp solvionyx_build/*.xz solvionyx_build/SHA256SUMS.txt \
          gs://${GCS_BUCKET}/aurora/${VERSION}/${EDITION}/

        gsutil acl ch -u AllUsers:R \
          gs://${GCS_BUCKET}/aurora/${VERSION}/${EDITION}/*

    # ---------------------------------------------------------
    - name: ðŸ“¦ Upload ISO Artifact to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: Solvionyx-Aurora-v6-Ultra-${{ matrix.edition }}-${{ env.VERSION }}
        path: |
          solvionyx_build/*.xz
          solvionyx_build/SHA256SUMS.txt

    # ---------------------------------------------------------
    - name: ðŸš€ Publish GitHub Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "Aurora-v6-ultra-${{ matrix.edition }}-${{ env.VERSION }}"
        name: "Solvionyx OS â€” Aurora v6 Ultra (${{ matrix.edition }})"
        body: |
          ðŸ” SecureBoot Enabled (shim + GRUB + Kernel signed)
          ðŸŒŒ Aurora v6 UI + Branding
          ðŸ–¥ Editions: GNOME, XFCE, KDE
          ðŸ“¦ Auto-uploaded to GCS + GitHub Releases
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
