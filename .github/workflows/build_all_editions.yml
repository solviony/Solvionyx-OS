name: Build & Upload Solvionyx OS Aurora (GNOME)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Aurora (GNOME)
    runs-on: ubuntu-24.04
    timeout-minutes: 90

    steps:
    - name: üß© Checkout repository
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debootstrap grub-pc-bin grub-efi-amd64-bin grub-common \
          syslinux isolinux syslinux-utils mtools xorriso squashfs-tools \
          rsync systemd-container genisoimage dosfstools xz-utils plymouth-theme-spinner

    - name: üß† Run Solvionyx Aurora ISO Builder
      run: |
        chmod +x build_iso_debian.sh
        sudo bash build_iso_debian.sh

    - name: üóúÔ∏è Compress ISO (maximum compression)
      run: |
        cd solvionyx_build
        echo "üóúÔ∏è Compressing Solvionyx Aurora ISO..."
        if ls *.iso 1> /dev/null 2>&1; then
          xz -T0 -9e Solvionyx-Aurora-*.iso
          echo "‚úÖ Compression complete."
          ls -lh Solvionyx-Aurora-*.iso.xz
          SIZE=$(stat -c%s Solvionyx-Aurora-*.iso.xz)
          if [ "$SIZE" -gt 2100000000 ]; then
            echo "‚ö†Ô∏è Warning: File still above 2 GB. Consider splitting next time."
          fi
        else
          echo "‚ùå No ISO found to compress."
          exit 1
        fi

    - name: üîê Generate checksums
      run: |
        cd solvionyx_build
        sha256sum *.xz > SHA256SUMS.txt
        chmod 644 SHA256SUMS.txt

    - name: üì¶ Upload compressed ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: Solvionyx-Aurora-v${{ github.run_number }}
        path: |
          solvionyx_build/Solvionyx-Aurora-*.iso.xz
          solvionyx_build/SHA256SUMS.txt

    - name: üöÄ Publish GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: Aurora-v${{ github.run_number }}
        name: "Solvionyx Aurora OS (GNOME) v${{ github.run_number }}"
        body: |
          **Solvionyx OS Aurora (GNOME Edition)**
          Tagline: *The engine behind the vision.*

          ‚úÖ Includes:
          - GNOME desktop environment
          - Calamares installer
          - Solvionyx branding
          - Live boot support (casper)

          üåê **Direct Download:**
          https://solviony.com/os/Solvionyx-Aurora-v${{ github.run_number }}.iso.xz

          üßæ **SHA256SUMS:**
          https://solviony.com/os/SHA256SUMS.txt
