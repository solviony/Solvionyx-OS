name: Build & Release Solvionyx OS Aurora (GNOME)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

env:
  AURORA_VERSION: v4.4.3
  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

defaults:
  run:
    shell: bash

jobs:
  gnome:
    name: Aurora (GNOME)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install build deps (auto-detect for Ubuntu/Debian)
        run: |
          sudo apt-get update
          if grep -qi ubuntu /etc/os-release; then
            echo "Detected Ubuntu runner — using grub2-common and grub-common"
            sudo apt-get install -y --no-install-recommends \
              debootstrap gdisk mtools dosfstools xorriso squashfs-tools \
              grub-pc-bin grub-efi-amd64-bin grub2-common grub-common \
              genisoimage ca-certificates curl rsync zip rclone jq unzip zstd
            echo "Installing AWS CLI v2..."
            if ! command -v aws &>/dev/null; then
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip -q awscliv2.zip
              sudo ./aws/install
            else
              echo "AWS CLI v2 already installed — skipping reinstall."
            fi
          else
            echo "Detected Debian runner — using grub-mkrescue"
            sudo apt-get install -y --no-install-recommends \
              debootstrap gdisk mtools dosfstools xorriso squashfs-tools \
              grub-pc-bin grub-efi-amd64-bin grub-mkrescue \
              genisoimage ca-certificates curl rsync zip rclone jq unzip zstd
            echo "Installing AWS CLI v2..."
            if ! command -v aws &>/dev/null; then
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip -q awscliv2.zip
              sudo ./aws/install
            else
              echo "AWS CLI v2 already installed — skipping reinstall."
            fi
          fi

      - name: Build Solvionyx OS ISO
        run: |
          chmod +x build_iso_debian.sh
          sudo DESKTOP=gnome ./build_iso_debian.sh

      - name: Compress ISO to under 2 GB (zstd)
        run: |
          mkdir -p release
          ISO=$(ls iso_output/*.iso | head -n 1)
          if [ -f "$ISO" ]; then
            echo "Compressing $ISO..."
            zstd -T0 -19 "$ISO" -o "release/$(basename "$ISO" .iso).zst"
            du -h "release/$(basename "$ISO" .iso).zst"
          else
            echo "❌ No ISO found to compress."
            exit 1
          fi

      - name: Generate checksums
        run: |
          cd release || exit 1
          sha256sum *.zst > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Upload compressed ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: Solvionyx-Aurora-v4.4.3
          path: release/

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*.zst
          tag_name: Aurora-v4.4.3
          name: Solvionyx OS Aurora v4.4.3 (GNOME)
          body: |
            ✅ **Solvionyx OS Aurora (GNOME)** v4.4.3  
            - Auto-built and compressed under 2 GB  
            - Bootable hybrid ISO with GNOME desktop  
            - SHA-256 checksums included  
            - Built via GitHub Actions AutoBuilder
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
