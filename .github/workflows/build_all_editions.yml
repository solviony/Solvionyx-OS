name: Build & Release Solvionyx OS Aurora (GNOME)

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]

permissions:
  contents: write

env:
  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
  AURORA_VERSION: v4.5.3  # auto-updated each release

jobs:
  gnome:
    name: Aurora (GNOME)
    runs-on: ubuntu-latest
    steps:
      - name: 🧩 Checkout repository
        uses: actions/checkout@v4

      - name: 🛠 Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-utils xorriso squashfs-tools genisoimage \
            debootstrap isolinux syslinux-utils grub2-common \
            rsync zstd

      - name: 🏗 Run Solvionyx Aurora ISO Builder
        run: |
          chmod +x build_iso_debian.sh
          sudo DESKTOP=gnome ./build_iso_debian.sh

      - name: 📦 Compress ISO (if exists)
        run: |
          mkdir -p release
          if ls iso_output/*.iso >/dev/null 2>&1; then
            for iso in iso_output/*.iso; do
              name=$(basename "$iso")
              zstd -f -T0 "$iso"
              mv "${iso}.zst" release/
            done
          else
            echo "⚠️ No ISO found in iso_output/"
          fi

      - name: 🧮 Generate checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS.txt
          cd ..

      - name: 🚀 Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Solvionyx-Aurora-${{ env.AURORA_VERSION }}
          path: release/

  publish:
    name: Publish GitHub Release
    needs: gnome
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Download built artifacts
        uses: actions/download-artifact@v4
        with:
          name: Solvionyx-Aurora-${{ env.AURORA_VERSION }}
          path: release/

      - name: 🧮 Recalculate SHA256SUMS
        run: |
          cd release
          sha256sum * > SHA256SUMS.txt
          cd ..

      - name: 🚀 Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: Aurora-${{ env.AURORA_VERSION }}
          name: Solvionyx OS Aurora ${{ env.AURORA_VERSION }}
          files: release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
