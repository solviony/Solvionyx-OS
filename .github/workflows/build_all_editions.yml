name: Build & Release Solvionyx OS Aurora (GNOME)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Aurora (GNOME)
    runs-on: ubuntu-24.04
    timeout-minutes: 120

    steps:
    - name: üß© Checkout repository
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Install dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          debootstrap grub-pc-bin grub-efi-amd64-bin grub-common \
          syslinux isolinux syslinux-utils mtools xorriso squashfs-tools \
          rsync systemd-container genisoimage dosfstools xz-utils curl

    - name: üß† Run Solvionyx Aurora ISO Builder
      run: |
        chmod +x build_iso_debian.sh
        sudo bash build_iso_debian.sh
        echo "‚úÖ Build process finished."

    - name: üîç Verify ISO existence
      run: |
        echo "Checking for ISO output..."
        ls -lh /home/runner/work/Solvionyx-OS/Solvionyx-OS/solvionyx_build || true
        find /home/runner/work/Solvionyx-OS/Solvionyx-OS -name "*.iso*" || echo "‚ùå No ISO file found!"

    - name: üóúÔ∏è Compress ISO (max compression)
      working-directory: /home/runner/work/Solvionyx-OS/Solvionyx-OS/solvionyx_build
      run: |
        echo "üóúÔ∏è Compressing ISO..."
        ISO_FILE=$(find . -maxdepth 1 -name "*.iso" | head -n1)
        if [ -z "$ISO_FILE" ]; then
          echo "‚ùå No ISO found to compress. Build step may have failed."
          exit 1
        fi
        xz -T0 -9e "$ISO_FILE"
        echo "‚úÖ Compression complete."
        ls -lh

    - name: üîê Generate checksums
      working-directory: /home/runner/work/Solvionyx-OS/Solvionyx-OS/solvionyx_build
      run: |
        sha256sum *.xz > SHA256SUMS.txt
        chmod 644 SHA256SUMS.txt
        echo "‚úÖ Checksums generated:"
        cat SHA256SUMS.txt

    - name: üåê Upload to Solviony.com via FTP
      env:
        FTP_HOST: ${{ secrets.FTP_HOST }}
        FTP_USER: ${{ secrets.FTP_USER }}
        FTP_PASS: ${{ secrets.FTP_PASS }}
      working-directory: /home/runner/work/Solvionyx-OS/Solvionyx-OS/solvionyx_build
      run: |
        echo "üåç Uploading to solviony.com/os ..."
        curl -T "*.xz" -u "$FTP_USER:$FTP_PASS" "ftp://$FTP_HOST/httpdocs/os/"
        curl -T "SHA256SUMS.txt" -u "$FTP_USER:$FTP_PASS" "ftp://$FTP_HOST/httpdocs/os/"
        echo "‚úÖ Upload complete."

    - name: üöÄ Publish GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: Aurora-v${{ github.run_number }}
        name: "Solvionyx Aurora OS (GNOME) v${{ github.run_number }}"
        body: |
          **Solvionyx OS Aurora (GNOME Edition)**
          Tagline: *The engine behind the vision.*

          ‚úÖ GNOME Desktop
          ‚úÖ Calamares Installer
          ‚úÖ Solvionyx Branding
          ‚úÖ Live Boot Support

          üåç **Direct Download:**
          https://solviony.com/os/Solvionyx-Aurora-v${{ github.run_number }}.iso.xz

          üßæ **Checksums:**
          https://solviony.com/os/SHA256SUMS.txt
        files: |
          /home/runner/work/Solvionyx-OS/Solvionyx-OS/solvionyx_build/*.xz
          /home/runner/work/Solvionyx-OS/Solvionyx-OS/solvionyx_build/SHA256SUMS.txt
