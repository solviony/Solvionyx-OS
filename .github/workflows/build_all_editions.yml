name: Build & Release Solvionyx OS Editions

on:
  workflow_dispatch: # Manual trigger
  push:
    branches: [ main ] # Trigger when main branch updates
  schedule:
    - cron: "0 3 * * *" # Nightly at 03:00 UTC

permissions:
  contents: write

env:
  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

jobs:
  build:
    name: Aurora (${{ matrix.desktop }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        desktop: [gnome, xfce, kde]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl wget rsync xorriso genisoimage squashfs-tools debootstrap gdisk dosfstools

      - name: Build ISO for ${{ matrix.desktop }}
        run: |
          chmod +x build_iso_debian.sh
          sudo DESKTOP=${{ matrix.desktop }} ./build_iso_debian.sh

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: Solvionyx-OS-${{ matrix.desktop }}
          path: iso_output/*.iso

  release:
    name: Publish Release (Aurora AutoBuilder)
    runs-on: ubuntu-latest
    needs: [ build ]
    if: always()

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd release
          if ls *.iso >/dev/null 2>&1; then
            sha256sum *.iso > SHA256SUMS.txt
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: Aurora-v4.3.9
          name: "Solvionyx OS Aurora v4.3.9"
          body: |
            âœ… Automated Aurora Builder Release (GNOME / XFCE / KDE)
            - Built from latest main branch
            - Includes auto versioning and checksum
            - Generated by Solvionyx AutoBuilder
          files: |
            release/*.iso
            release/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

