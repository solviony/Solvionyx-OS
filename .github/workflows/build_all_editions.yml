name: Build & Release Solvionyx OS â€” Aurora v6 Ultra

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write
  id-token: write

jobs:
  build:
    name: Build Solvionyx OS Aurora â€” ${{ matrix.edition }}
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    strategy:
      fail-fast: false
      matrix:
        edition: [gnome, kde, xfce]

    steps:
      # ---------------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debootstrap \
            xorriso \
            squashfs-tools \
            syslinux isolinux syslinux-utils \
            grub-pc-bin grub-efi-amd64-bin grub-common \
            mtools \
            dosfstools \
            systemd-container \
            libssl-dev \
            sbsigntool \
            shim-signed \
            efitools \
            git \
            wget curl unzip rsync \
            plymouth plymouth-themes plymouth-label

      # ---------------------------------------------------------
      # RESTORE SECUREBOOT KEYS
      # ---------------------------------------------------------
      - name: Restore SecureBoot Keys
        run: |
          mkdir -p secureboot
          echo "${{ secrets.SECUREBOOT_DB_KEY }}" > secureboot/db.key
          echo "${{ secrets.SECUREBOOT_DB_CRT }}" > secureboot/db.crt
          chmod 600 secureboot/db.key
          chmod 644 secureboot/db.crt
      - name: Restore SecureBoot Keys
        run: |
          mkdir -p secureboot
          echo "${{ secrets.SECUREBOOT_DB_KEY_B64 }}" | base64 -d > secureboot/db.key
          echo "${{ secrets.SECUREBOOT_DB_CRT_B64 }}" | base64 -d > secureboot/db.crt

      # ---------------------------------------------------------
      # RUN BUILDER SCRIPT
      # ---------------------------------------------------------
      - name: ðŸ›  Run Solvionyx Builder â€” ${{ matrix.edition }}
        shell: bash
        run: |
          chmod +x build/builder_v6_ultra.sh
          sudo bash build/builder_v6_ultra.sh "${{ matrix.edition }}"

      # ---------------------------------------------------------
      # LOCATE OUTPUT (signed + compressed)
      # ---------------------------------------------------------
      - name: Locate Output Artifact
        id: iso_path
        run: |
          OUT=$(ls solvionyx_build/*.xz | head -n 1)
          echo "ISO_OUT=$OUT" >> $GITHUB_ENV
          echo "Found artifact: $OUT"

      # ---------------------------------------------------------
      # Upload per-edition artifacts
      # ---------------------------------------------------------
      - name: Upload ISO Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Solvionyx-Aurora-${{ matrix.edition }}
          path: |
            solvionyx_build/*.xz
            solvionyx_build/SHA256SUMS.txt

  # ---------------------------------------------------------
  # UNIFIED RELEASE JOB
  # ---------------------------------------------------------
  release:
    name: Publish Unified Solvionyx Aurora Release
    runs-on: ubuntu-24.04
    needs: build
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_artifacts

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "Aurora-v6-${{ github.run_number }}"
          name: "Solvionyx OS â€” Aurora v6 Ultra"
          body: |
            ## Solvionyx OS â€” Aurora v6 Ultra
            ### Editions Included:
            - GNOME
            - KDE
            - XFCE

            ### Status:
            - SecureBoot: Fully Signed
            - Installer: Calamares (Branded)
            - Solvy AI: Integrated
            - Welcome App: Integrated
            - Aurora V6 Branding: Applied

            ### Files:
            All signed ISO images (.iso.xz) and checksum files are included below.
          files: release_artifacts/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
