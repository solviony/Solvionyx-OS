name: Build & Release Solvionyx OS â€” Aurora v6 Ultra

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  # =========================================================
  # BUILD JOB (UNCHANGED)
  # =========================================================
  build:
    name: Build Solvionyx OS Aurora â€” ${{ matrix.edition }}
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    strategy:
      fail-fast: false
      matrix:
        edition: [gnome, kde, xfce]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debootstrap \
            xorriso \
            isolinux syslinux-common syslinux-utils \
            grub-pc-bin grub-efi-amd64-bin grub-common \
            shim-signed \
            mtools \
            squashfs-tools \
            dosfstools \
            sbsigntool \
            efitools \
            zstd \
            rsync wget curl

      - name: Restore SecureBoot Keys (Base64 Decode)
        run: |
          mkdir -p secureboot
          echo "${{ secrets.SECUREBOOT_DB_KEY_B64 }}" | base64 -d > secureboot/db.key
          echo "${{ secrets.SECUREBOOT_DB_CRT_B64 }}" | base64 -d > secureboot/db.crt
          chmod 600 secureboot/db.key
          chmod 644 secureboot/db.crt

      - name: ðŸ›  Run Solvionyx Builder â€” ${{ matrix.edition }}
        shell: bash
        run: |
          chmod +x build/builder_v6_ultra.sh
          sudo bash build/builder_v6_ultra.sh "${{ matrix.edition }}"

      - name: Upload ISO Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Solvionyx-Aurora-${{ matrix.edition }}
          path: |
            solvionyx_build/*.xz
            solvionyx_build/SHA256SUMS.txt

  # =========================================================
  # RELEASE JOB (GCS UPLOAD â€“ FIXED & RELIABLE)
  # =========================================================
  release:
    name: Publish Unified Solvionyx Aurora Release
    runs-on: ubuntu-24.04
    needs: build
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_artifacts

      # ---------------------------------------------------------
      # AUTHENTICATE TO GOOGLE CLOUD (FIXED ORDER)
      # ---------------------------------------------------------
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # ---------------------------------------------------------
      # UPLOAD LARGE FILES TO GCS
      # ---------------------------------------------------------
      - name: Upload ISOs to Google Cloud Storage
        run: |
          BUCKET="${{ secrets.GCS_BUCKET }}"
          VERSION="Aurora-v6-${{ github.run_number }}"

          find release_artifacts -name "*.xz" -print0 | \
            xargs -0 -I{} gsutil cp {} gs://$BUCKET/$VERSION/

          find release_artifacts -name "SHA256SUMS.txt" -print0 | \
            xargs -0 -I{} gsutil cp {} gs://$BUCKET/$VERSION/

      # ---------------------------------------------------------
      # UPDATE LATEST ALIAS (FIXED POSITION)
      # ---------------------------------------------------------
      - name: Update latest GCS alias
        run: |
          BUCKET="${{ secrets.GCS_BUCKET }}"
          VERSION="Aurora-v6-${{ github.run_number }}"

          gsutil -m rm -r gs://$BUCKET/latest || true
          gsutil -m cp -r gs://$BUCKET/$VERSION gs://$BUCKET/latest

      # ---------------------------------------------------------
      # GENERATE SIGNED DOWNLOAD URLS (FIXED)
      # ---------------------------------------------------------
      - name: Generate Signed Download URLs
        run: |
          BUCKET="${{ secrets.GCS_BUCKET }}"
          VERSION="Aurora-v6-${{ github.run_number }}"
          EXPIRE_SECONDS=604800

          echo '${{ secrets.GCP_SA_KEY }}' > sa.json

          echo "## Solvionyx OS â€” Aurora v6 Ultra" > release_body.md
          echo "" >> release_body.md
          echo "### Secure Downloads (Signed URLs â€” valid 7 days)" >> release_body.md
          echo "" >> release_body.md

          for f in release_artifacts/**/**/*.xz; do
            NAME=$(basename "$f")
            URL=$(gsutil signurl -d ${EXPIRE_SECONDS}s sa.json \
              gs://$BUCKET/$VERSION/$NAME | tail -n 1 | awk '{print $5}')
            echo "- [$NAME]($URL)" >> release_body.md
          done

          rm -f sa.json

          echo "" >> release_body.md
          echo "SHA256 checksums are included in the same directory." >> release_body.md

      # ---------------------------------------------------------
      # GENERATE STATIC DOWNLOAD PAGE
      # ---------------------------------------------------------
      - name: Generate static download page
        run: |
          BUCKET="${{ secrets.GCS_BUCKET }}"

          cat <<EOF > index.html
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Solvionyx OS â€” Aurora</title>
            <style>
              body { font-family: system-ui; background:#0b1220; color:#fff; padding:40px }
              a { color:#4fc3ff; text-decoration:none }
              .card { background:#111827; padding:20px; border-radius:12px; max-width:700px }
            </style>
          </head>
          <body>
            <div class="card">
              <h1>Solvionyx OS â€” Aurora v6 Ultra</h1>
              <p>Official downloads</p>
              <ul>
          EOF

          gsutil ls gs://$BUCKET/latest/*.xz | while read f; do
            NAME=$(basename "$f")
            echo "<li><a href=\"$f\">$NAME</a></li>" >> index.html
          done

          cat <<EOF >> index.html
              </ul>
            </div>
          </body>
          </html>
          EOF

          gsutil cp index.html gs://$BUCKET/index.html

      # ---------------------------------------------------------
      # CLEANUP OLD BUILDS (KEEP LATEST 5)
      # ---------------------------------------------------------
      - name: Cleanup Old GCS Builds
        run: |
          BUCKET="${{ secrets.GCS_BUCKET }}"
          KEEP=5

          gsutil ls gs://$BUCKET/ | sed 's|gs://||' | sort -r | tail -n +$((KEEP+1)) | while read OLD; do
            echo "Deleting old build: gs://$OLD"
            gsutil -m rm -r gs://$OLD || true
          done

      # ---------------------------------------------------------
      # PUBLISH GITHUB RELEASE
      # ---------------------------------------------------------
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "Aurora-v6-${{ github.run_number }}"
          name: "Solvionyx OS â€” Aurora v6 Ultra"
          body_path: release_body.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
