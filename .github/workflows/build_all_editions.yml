name: Build & Release Solvionyx OS Aurora (GNOME)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 3 * * *"  # nightly build

permissions:
  contents: write

env:
  AURORA_VERSION: v4.6.0
  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

jobs:
  gnome:
    name: Aurora (GNOME)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debootstrap squashfs-tools xorriso grub-pc-bin grub-efi-amd64-bin \
            mtools isolinux syslinux-utils xz-utils git curl wget rsync

      - name: Run Solvionyx Aurora ISO Builder
        run: |
          chmod +x build_iso_debian.sh
          ./build_iso_debian.sh

      # üîß FIXED PATH: Properly locate and compress ISO
      - name: Compress ISO (if not already compressed)
        run: |
          cd solvionyx_build || exit 1
          if ls *.iso >/dev/null 2>&1; then
            echo "üóúÔ∏è Compressing Solvionyx ISO..."
            xz -T0 -z *.iso
          else
            echo "‚ö†Ô∏è No uncompressed ISO found, skipping compression."
          fi

      # ‚úÖ Generate checksum file
      - name: Generate checksums
        run: |
          cd solvionyx_build || exit 1
          echo "üì¶ Generating SHA256SUMS.txt..."
          sudo chmod -R a+rw .
          sha256sum *.xz > SHA256SUMS.txt
          cat SHA256SUMS.txt

      # ‚úÖ Upload build artifact
      - name: Upload compressed ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: Solvionyx-Aurora-${{ env.AURORA_VERSION }}
          path: solvionyx_build/*.xz

      # ‚úÖ Publish GitHub Release automatically
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: Aurora-${{ env.AURORA_VERSION }}
          name: "Solvionyx OS Aurora ${{ env.AURORA_VERSION }}"
          body: |
            üåå **Solvionyx OS Aurora (GNOME) ‚Äî Official Build**
            Version: **${{ env.AURORA_VERSION }}**

            _‚ÄúThe engine behind the vision.‚Äù_

            ### Included:
            - GNOME Desktop Environment
            - Calamares Installer (Solvionyx Branding)
            - Live User: `solvionyx` / password: `solvionyx`

            ### Checksums:
            ```
            $(cat solvionyx_build/SHA256SUMS.txt)
            ```

          files: |
            solvionyx_build/*.xz
            solvionyx_build/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
