name: Build & Release Solvionyx OS Aurora (GNOME)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

env:
  AURORA_VERSION: v4.5.6
  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

jobs:
  gnome:
    name: Aurora (GNOME)
    runs-on: ubuntu-latest

    steps:
      - name: 🧩 Checkout repository
        uses: actions/checkout@v4

      - name: 🧰 Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            grub2-common grub-pc-bin grub-efi-amd64-bin grub-efi-ia32-bin \
            xorriso squashfs-tools debootstrap dosfstools gdisk genisoimage rsync curl wget \
            mtools isolinux syslinux syslinux-utils efibootmgr dosfstools \
            apt-utils ca-certificates dialog locales systemd-sysv xz-utils

      - name: 🧠 Run Solvionyx Aurora ISO Builder
        run: |
          chmod +x build_iso_debian.sh
          sudo ./build_iso_debian.sh

      - name: Compress ISO (if not already compressed)
        run: |
    cd solvionyx_build || exit 1
    if ls *.iso >/dev/null 2>&1; then
      echo "Compressing Solvionyx ISO..."
      xz -T0 -z *.iso
    else
      echo "⚠️ No uncompressed ISO found, skipping compression."
    fi

      - name: 🔒 Generate checksums
        run: |
          cd iso_output
          sha256sum *.xz > SHA256SUMS.txt

      - name: 📦 Upload compressed ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: Solvionyx-Aurora-${{ env.AURORA_VERSION }}
          path: |
            iso_output/*.xz
            iso_output/*.sha256
            iso_output/SHA256SUMS.txt

  publish:
    name: 🚀 Publish GitHub Release
    needs: [ gnome ]
    runs-on: ubuntu-latest

    steps:
      - name: 🧩 Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release

      - name: 🔒 Prepare checksums
        run: |
          cd release
          if [ -f *.xz ]; then
            sha256sum *.xz > SHA256SUMS.txt
          fi

      - name: 🚀 Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: Aurora-${{ env.AURORA_VERSION }}
          name: Solvionyx OS Aurora GNOME ${{ env.AURORA_VERSION }}
          body: |
            ### 🌌 Solvionyx OS Aurora GNOME ${{ env.AURORA_VERSION }}
            - Built automatically using Solvionyx AutoBuilder
            - Optimized GNOME desktop
            - Hybrid ISO (UEFI + BIOS)
            - XZ compression and SHA256 integrity verification

            🧠 **Checksum File:** `SHA256SUMS.txt`
            💿 **Edition:** GNOME

            ---
            🔗 **Website:** [solviony.com/page/os](https://solviony.com/page/os)
          files: |
            release/*.xz
            release/*.sha256
            release/SHA256SUMS.txt
