name: Build & Release Solvionyx OS Aurora (GNOME Edition)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: 🧠 Solvionyx OS — Aurora (GNOME)
    runs-on: ubuntu-24.04
    timeout-minutes: 90

    steps:
    # ---------------------------------------------------
    # 1. Checkout
    # ---------------------------------------------------
    - name: 🧩 Checkout repository
      uses: actions/checkout@v4

    # ---------------------------------------------------
    # 2. Dependencies
    # ---------------------------------------------------
    - name: ⚙️ Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debootstrap grub-pc-bin grub-efi-amd64-bin grub-common \
          syslinux isolinux syslinux-utils mtools xorriso squashfs-tools \
          rsync systemd-container genisoimage dosfstools xz-utils jq \
          plymouth-theme-spinner python3-pip
        # AWS CLI via pip (Ubuntu 24.04 compatible)
        sudo pip install awscli --break-system-packages

    # ---------------------------------------------------
    # 3. Build ISO
    # ---------------------------------------------------
    - name: 💿 Run Solvionyx Aurora ISO Builder
      run: |
        echo "🧠 Starting Solvionyx OS build..."
        chmod +x build_iso_debian.sh
        sudo bash build_iso_debian.sh
        echo "✅ Solvionyx Aurora ISO build finished."

    # ---------------------------------------------------
    # 4. Verify ISO File
    # ---------------------------------------------------
    - name: 🔍 Verify Solvionyx ISO existence
      run: |
        echo "🔍 Checking for ISO..."
        sudo chmod -R 755 solvionyx_build || true
        ISO_PATH=$(sudo find solvionyx_build -type f -name "*.iso*" 2>/dev/null | head -n 1)
        if [ -z "$ISO_PATH" ]; then
          echo "❌ ISO not found in solvionyx_build."
          sudo ls -l solvionyx_build || true
          exit 1
        else
          echo "✅ ISO found at: $ISO_PATH"
        fi

    # ---------------------------------------------------
    # 5. Compress ISO
    # ---------------------------------------------------
    - name: 🗜️ Compress Solvionyx ISO (if not already compressed)
      run: |
        cd solvionyx_build
        if ls *.iso.xz 1> /dev/null 2>&1; then
          echo "✅ ISO already compressed."
        else
          echo "🗜️ Compressing ISO..."
          xz -T0 -9e *.iso
        fi

    # ---------------------------------------------------
    # 6. Generate Checksums (fixed permissions)
    # ---------------------------------------------------
    - name: 🔐 Generate SHA256 checksums (with sudo)
      run: |
        echo "🔐 Generating SHA256 checksums..."
        sudo chmod -R 777 solvionyx_build
        cd solvionyx_build
        sudo bash -c 'sha256sum *.iso.xz > SHA256SUMS.txt'
        sudo chmod 644 SHA256SUMS.txt
        echo "✅ SHA256SUMS.txt created successfully:"
        cat SHA256SUMS.txt

    # ---------------------------------------------------
    # 7. Configure AWS Credentials
    # ---------------------------------------------------
    - name: ☁️ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

    # ---------------------------------------------------
    # 8. Upload to AWS S3
    # ---------------------------------------------------
    - name: ☁️ Upload to AWS S3 (Versioned, Latest, and JSON)
      env:
        S3_BUCKET: solvionyx-releases
      run: |
        echo "☁️ Uploading Solvionyx Aurora ISO to S3..."
        VERSION="v${{ github.run_number }}"
        ISO_DIR="solvionyx_build"
        REGION="${{ secrets.AWS_DEFAULT_REGION }}"
        BUCKET_URL="https://solvionyx-releases.s3.${REGION}.amazonaws.com"

        ISO_FILE=$(ls $ISO_DIR/*.iso.xz | head -n 1)
        [ -f "$ISO_FILE" ] || { echo "❌ No ISO file found!"; exit 1; }

        aws s3 cp "$ISO_FILE" "s3://$S3_BUCKET/aurora/$VERSION/" --no-acl
        aws s3 cp "$ISO_DIR/SHA256SUMS.txt" "s3://$S3_BUCKET/aurora/$VERSION/" --no-acl
        aws s3 cp "$ISO_FILE" "s3://$S3_BUCKET/aurora/latest/" --no-acl
        aws s3 cp "$ISO_DIR/SHA256SUMS.txt" "s3://$S3_BUCKET/aurora/latest/" --no-acl

        echo "✅ Upload complete."

        # Create latest.json for solviony.com auto-sync
        ISO_NAME=$(basename "$ISO_FILE")
        SHA256_HASH=$(sha256sum "$ISO_FILE" | awk '{print $1}')
        DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        cat > latest.json <<EOF
        {
          "version": "${VERSION}",
          "release_name": "Solvionyx OS Aurora (GNOME)",
          "tagline": "The engine behind the vision.",
          "build_date": "${DATE}",
          "iso_name": "${ISO_NAME}",
          "sha256": "${SHA256_HASH}",
          "download_url": "${BUCKET_URL}/aurora/latest/${ISO_NAME}",
          "checksum_url": "${BUCKET_URL}/aurora/latest/SHA256SUMS.txt"
        }
        EOF

        cat latest.json
        aws s3 cp latest.json "s3://$S3_BUCKET/aurora/latest/latest.json" --no-acl
        echo "✅ latest.json uploaded successfully."

    # ---------------------------------------------------
    # 9. GitHub Release
    # ---------------------------------------------------
    - name: 🚀 Publish GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: Aurora-v${{ github.run_number }}
        name: "Solvionyx Aurora OS (GNOME) v${{ github.run_number }}"
        body: |
          ## 🧠 Solvionyx OS Aurora (GNOME Edition)
          **Tagline:** The engine behind the vision.  
          **Brand:** Solvionyx — AI-powered Linux for creators, engineers, and innovators.

          ✅ Includes:
          - GNOME desktop environment  
          - Calamares installer  
          - Solvionyx branding  
          - Live boot support (casper)  

          🌐 **Download (AWS S3):**  
          https://solvionyx-releases.s3.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com/aurora/v${{ github.run_number }}/Solvionyx-Aurora-v${{ github.run_number }}.iso.xz

          🧾 **Checksums:**  
          https://solvionyx-releases.s3.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com/aurora/v${{ github.run_number }}/SHA256SUMS.txt

          📦 **Web JSON Sync:**  
          https://solvionyx-releases.s3.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com/aurora/latest/latest.json

    # ---------------------------------------------------
    # 10. Build Summary
    # ---------------------------------------------------
    - name: 📋 Post Build Summary
      run: |
        echo "🧾 Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "✅ Solvionyx Aurora OS build completed successfully." >> $GITHUB_STEP_SUMMARY
        echo "🌍 S3 URL: https://solvionyx-releases.s3.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com/aurora/latest/" >> $GITHUB_STEP_SUMMARY
