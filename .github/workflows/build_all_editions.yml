name: Build & Upload Solvionyx OS Aurora (GNOME)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Aurora (GNOME)
    runs-on: ubuntu-24.04
    timeout-minutes: 90

    steps:
    - name: üß© Checkout repository
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debootstrap grub-pc-bin grub-efi-amd64-bin grub-common \
          syslinux isolinux syslinux-utils mtools xorriso squashfs-tools \
          rsync systemd-container genisoimage dosfstools xz-utils plymouth-theme-spinner lftp

    - name: üß† Run Solvionyx Aurora ISO Builder
      run: |
        chmod +x build_iso_debian.sh
        sudo bash build_iso_debian.sh

    - name: üóúÔ∏è Compress ISO
      run: |
        cd solvionyx_build
        for f in Solvionyx-Aurora-*.iso; do
          mv "$f" "Solvionyx-Aurora-v${{ github.run_number }}.iso"
        done
        xz -T0 -9e Solvionyx-Aurora-v${{ github.run_number }}.iso
        sha256sum Solvionyx-Aurora-v${{ github.run_number }}.iso.xz > SHA256SUMS.txt

    - name: üåê Upload to Solviony.com
      env:
        SFTP_USER: ${{ secrets.SOLVIONYX_SFTP_USER }}
        SFTP_PASS: ${{ secrets.SOLVIONYX_SFTP_PASS }}
      run: |
        cd solvionyx_build
        echo "üåç Uploading Solvionyx Aurora to solviony.com..."
        lftp -u "$SFTP_USER","$SFTP_PASS" sftp://solviony.com <<EOF
        cd httpdocs/os/
        put Solvionyx-Aurora-v${{ github.run_number }}.iso.xz
        put SHA256SUMS.txt
        bye
        EOF
        echo "‚úÖ Upload complete: https://solviony.com/os/"

    - name: üöÄ Publish GitHub Release (metadata only)
      uses: softprops/action-gh-release@v1
      with:
        tag_name: Aurora-v${{ github.run_number }}
        name: "Solvionyx Aurora OS (GNOME) v${{ github.run_number }}"
        body: |
          **Solvionyx OS Aurora (GNOME Edition)**
          Tagline: *The engine behind the vision.*

          ‚úÖ GNOME desktop
          ‚úÖ Calamares installer
          ‚úÖ Solvionyx branding
          ‚úÖ Live boot support

          üåê **Direct Download:**  
          https://solviony.com/os/Solvionyx-Aurora-v${{ github.run_number }}.iso.xz

          üßæ SHA256SUMS:  
          https://solviony.com/os/SHA256SUMS.txt

