name: Build & Release Solvionyx OS — Aurora Ultra

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        edition: [gnome, kde, xfce]

    env:
      OS_NAME: "SolvionyxOS"
      OS_FLAVOR: "Aurora"
      GCS_BUCKET: "solvionyx-os"
      VERSION_DATE: ${{ github.run_id }}
      ISO_DATE: ${{ github.run_number }}

    steps:
      # ---------------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            live-build debootstrap squashfs-tools \
            syslinux isolinux xorriso mtools \
            grub-pc-bin grub-efi-amd64-bin grub-common \
            python3 python3-pyqt5 python3-pip \
            plymouth plymouth-themes \
            sbsigntool shim-signed mokutil \
            xz-utils rsync curl unzip \
            speech-dispatcher-espeak-ng \
            imagemagick qml-module-qtquick-controls2

      # ---------------------------------------------------------
      # Build RootFS + Install Branding, Solvy, Welcome, Calamares
      # ---------------------------------------------------------
      - name: Prepare RootFS
        run: sudo bash build/build_rootfs.sh

      # ---------------------------------------------------------
      # Build Unsigned ISO (Edition-based)
      # ---------------------------------------------------------
      - name: Build Unsigned ISO
        run: sudo bash build/build_iso_debian.sh ${{ matrix.edition }}

      - name: Locate Unsigned ISO
        id: iso_find
        run: |
          ISO=$(ls build/output/*.iso | head -n 1)
          echo "ISO_PATH=$ISO" >> $GITHUB_ENV
          echo "Found ISO: $ISO"

      # ---------------------------------------------------------
      # SecureBoot: Extract, Sign GRUB + Kernel, Repack ISO
      # ---------------------------------------------------------
      - name: Extract shim + GRUB EFI
        run: |
          mkdir -p efi-bin
          cp /usr/lib/shim/shimx64.efi.signed efi-bin/bootx64.efi
          cp /usr/lib/shim/mmx64.efi efi-bin/
          cp /usr/lib/grub/x86_64-efi-signed/grubx64.efi.signed efi-bin/grubx64.efi

      - name: Generate SecureBoot Keys
        run: |
          mkdir -p secureboot/sbat secureboot/out

          openssl req -new -x509 -newkey rsa:4096 -nodes \
            -keyout secureboot/db.key \
            -out secureboot/db.crt \
            -days 3650 \
            -subj "/C=US/O=Solvionyx/CN=Solvionyx-DB"

          echo "sbat,1,Solviony,Solvionyx-OS,1,https://solviony.com/security/" \
            > secureboot/sbat/grub-sbat.txt

      - name: Sign GRUB + Kernel
        run: |
          mkdir -p iso_signed
          xorriso -osirrox on -indev "$ISO_PATH" -extract / iso_signed/

          # SBAT
          cp secureboot/sbat/grub-sbat.txt iso_signed/boot/grub/grubx64.efi.sbat || true

          # Sign GRUB
          sbsign \
            --key secureboot/db.key \
            --cert secureboot/db.crt \
            --output iso_signed/EFI/ubuntu/grubx64.efi \
            efi-bin/grubx64.efi

          # Sign Kernel
          KERNEL=$(find iso_signed/live -name "vmlinuz*" | head -n 1)
          sbsign \
            --key secureboot/db.key \
            --cert secureboot/db.crt \
            --output "${KERNEL}.signed" \
            "$KERNEL"
          mv "${KERNEL}.signed" "$KERNEL"

          # Insert SHIM + MM
          mkdir -p iso_signed/EFI/boot
          cp efi-bin/bootx64.efi iso_signed/EFI/boot/
          cp efi-bin/mmx64.efi iso_signed/EFI/boot/

      - name: Repack SecureBoot ISO
        run: |
          OUT="build/output/SecureBoot-${{ matrix.edition }}-${{ github.run_number }}.iso"
          xorriso -as mkisofs \
            -o "$OUT" \
            -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
            -c isolinux/boot.cat \
            -b isolinux/isolinux.bin \
            -no-emul-boot -boot-load-size 4 -boot-info-table \
            -eltorito-alt-boot -e boot/grub/efi.img -no-emul-boot \
            -isohybrid-gpt-basdat \
            iso_signed/
          echo "SIGNED_ISO=$OUT" >> $GITHUB_ENV

      # ---------------------------------------------------------
      # Compress + Upload Artifacts
      # ---------------------------------------------------------
      - name: Compress ISO
        run: |
          xz -T0 -9 "$SIGNED_ISO"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Solvionyx-Aurora-${{ matrix.edition }}
          path: |
            build/output/*.xz

      # ---------------------------------------------------------
      # Upload to Google Cloud Storage
      # ---------------------------------------------------------
      - name: Upload to GCS
        run: |
          gsutil -m cp build/output/*.xz gs://solvionyx-os/aurora/latest/${{ matrix.edition }}/
          gsutil acl ch -u AllUsers:R gs://solvionyx-os/aurora/latest/${{ matrix.edition }}/*

  # -------------------------------------------------------------
  # Unified GitHub Release Creation (after ALL editions finish)
  # -------------------------------------------------------------
  release:
    runs-on: ubuntu-24.04
    needs: build
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish Unified Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "Aurora-${{ github.run_number }}"
          name: "Solvionyx OS — Aurora Ultra"
          body: |
            ## Solvionyx OS — Aurora Ultra
            ### Editions:
            - GNOME
            - KDE
            - XFCE

            ### SecureBoot: Enabled
            ### Calamares Installer: Enabled
            ### Solvy AI + Welcome App Integrated

            ### Artifacts Included:
            Download each edition’s signed ISO in this release.
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
