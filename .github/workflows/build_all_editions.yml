name: Build & Release Solvionyx OS Aurora (GNOME)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Aurora (GNOME)
    runs-on: ubuntu-24.04
    timeout-minutes: 120

    steps:
    - name: üß© Checkout repository
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debootstrap grub-pc-bin grub-efi-amd64-bin grub-common \
          syslinux isolinux syslinux-utils mtools xorriso squashfs-tools \
          rsync systemd-container genisoimage dosfstools xz-utils lftp

    - name: üß† Run Solvionyx Aurora ISO Builder
      run: |
        chmod +x build_iso_debian.sh
        sudo bash build_iso_debian.sh

    - name: üßπ Normalize permissions
      run: |
        echo "üîß Fixing permissions..."
        sudo chmod -R 777 solvionyx_build || true
        sudo chown -R $USER:$USER solvionyx_build || true
        ls -lh solvionyx_build | grep .iso || true

    - name: üîç Verify ISO existence
      run: |
        echo "üîç Searching for ISO..."
        find solvionyx_build -maxdepth 2 -type f \( -name "*.iso" -o -name "*.iso.xz" \)
        if ! find solvionyx_build -type f -name "*.iso*" | grep -q .; then
          echo "‚ùå No ISO file found!"
          exit 1
        else
          echo "‚úÖ ISO file located successfully."
        fi

    - name: üóúÔ∏è Compress ISO (max compression)
      run: |
        echo "üóúÔ∏è Compressing ISO..."
        cd solvionyx_build
        FILE=$(find . -maxdepth 1 -type f -name "*.iso" | head -n1)
        if [ -z "$FILE" ]; then
          echo "‚ùå No ISO found to compress. Build step may have failed."
          exit 1
        fi
        xz -T0 -9e "$FILE"
        echo "‚úÖ Compression complete."
        ls -lh *.xz

    - name: üîê Generate checksums
      run: |
        cd solvionyx_build
        sha256sum *.xz > SHA256SUMS.txt
        chmod 644 SHA256SUMS.txt
        cat SHA256SUMS.txt

    - name: üåê Upload to Solviony.com via FTP
      env:
        FTP_HOST: ${{ secrets.FTP_HOST }}
        FTP_USER: ${{ secrets.FTP_USER }}
        FTP_PASS: ${{ secrets.FTP_PASS }}
      run: |
        echo "üåç Uploading ISO and checksum to solviony.com..."
        lftp -e "
          set ssl:verify-certificate no;
          open -u $FTP_USER,$FTP_PASS $FTP_HOST;
          cd /httpdocs/os;
          mrm Solvionyx-Aurora*.iso.xz || true;
          mrm SHA256SUMS.txt || true;
          put -O /httpdocs/os solvionyx_build/*.iso.xz;
          put -O /httpdocs/os solvionyx_build/SHA256SUMS.txt;
          bye;
        "
        echo "‚úÖ Upload completed successfully."

    - name: üöÄ Publish GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: Aurora-v${{ github.run_number }}
        name: "Solvionyx Aurora OS (GNOME) v${{ github.run_number }}"
        body: |
          **Solvionyx OS Aurora (GNOME Edition)**  
          Tagline: *"The engine behind the vision."*

          ‚úÖ GNOME desktop  
          ‚úÖ Calamares installer  
          ‚úÖ Solvionyx branding  
          ‚úÖ Live boot support  

          üåç [Direct Download (Solviony.com)](https://solviony.com/os/Solvionyx-Aurora-v${{ github.run_number }}.iso.xz)  
          üìú [SHA256SUMS](https://solviony.com/os/SHA256SUMS.txt)
