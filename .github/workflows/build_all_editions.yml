name: Build & Release Solvionyx OS — Aurora (GNOME/XFCE/KDE + GCS + Artifacts)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build:
    name: 🧠 Solvionyx OS — Aurora (${{ matrix.edition }})
    runs-on: ubuntu-24.04
    timeout-minutes: 150

    strategy:
      matrix:
        edition: [gnome, xfce, kde]
      fail-fast: false

    env:
      GCS_BUCKET: solvionyx-os
      GCP_PROJECT: iconic-biplane-476304-u8
      VERSION: v${{ github.run_number }}
      ISO_DIR: solvionyx_build
      BRAND_LOGO: branding/4023.png
      BRAND_BG: branding/4022.jpg

    steps:
      # ---------------------------------------------------
      # 1. Checkout
      # ---------------------------------------------------
      - name: 🧩 Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # 2. Install dependencies
      # ---------------------------------------------------
      - name: ⚙️ Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debootstrap grub-pc-bin grub-efi-amd64-bin grub-common \
            syslinux isolinux syslinux-utils mtools xorriso squashfs-tools \
            rsync systemd-container genisoimage dosfstools xz-utils jq curl unzip \
            plymouth plymouth-themes plymouth-label imagemagick

      # ---------------------------------------------------
      # 3. Setup Google Cloud SDK + Auth
      # ---------------------------------------------------
      - name: ☁️ Install gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}
          install_components: 'gsutil'

      - name: 🔐 Write and Activate Service Account Key
        run: |
          echo '${{ secrets.GCS_CREDENTIALS_JSON }}' > gcp-key.json
          chmod 600 gcp-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=$PWD/gcp-key.json
          export CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE=$PWD/gcp-key.json
          gcloud auth activate-service-account --key-file "$GOOGLE_APPLICATION_CREDENTIALS"
          gcloud config set project "${GCP_PROJECT}"
          gcloud auth list

      - name: 🔎 Verify GCS Access
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS=$PWD/gcp-key.json
          gsutil ls "gs://${GCS_BUCKET}" || (echo "❌ Cannot access bucket!" && exit 1)
          echo "✅ GCS bucket is reachable."

      # ---------------------------------------------------
      # 4. Branding Check / Fallback
      # ---------------------------------------------------
      - name: 🎨 Ensure branding assets
        run: |
          mkdir -p branding
          if [ ! -f "${BRAND_LOGO}" ]; then
            echo "⚠️ ${BRAND_LOGO} missing — creating fallback logo..."
            convert -size 512x128 xc:'#0b1220' -gravity center \
              -fill '#6f3bff' -pointsize 36 -annotate 0 'SOLVIONYX' "${BRAND_LOGO}"
          fi
          if [ ! -f "${BRAND_BG}" ]; then
            echo "ℹ️ ${BRAND_BG} missing — will rely on dark gradient fallback."
          fi

      # ---------------------------------------------------
      # 5. Build ISO
      # ---------------------------------------------------
      - name: 💿 Build Solvionyx OS ISO (${{ matrix.edition }})
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS=$PWD/gcp-key.json
          chmod +x build_iso_debian.sh
          export SOLVIONYX_LOGO_PATH="${BRAND_LOGO}"
          export SOLVIONYX_BG_PATH="${BRAND_BG}"
          ./build_iso_debian.sh "${{ matrix.edition }}"

      # ---------------------------------------------------
      # 6. Compress ISO
      # ---------------------------------------------------
      - name: 🗜️ Compress ISO
        run: |
          cd "${ISO_DIR}"
          RAW_ISO=$(ls *.iso 2>/dev/null | head -n 1 || true)
          if [ -n "$RAW_ISO" ] && [ ! -f "${RAW_ISO}.xz" ]; then
            echo "🗜️ Compressing $RAW_ISO..."
            xz -T2 -5 "${RAW_ISO}"
          else
            echo "ℹ️ ISO already compressed or not found."
          fi

      # ---------------------------------------------------
      # 7. Generate Checksums
      # ---------------------------------------------------
      - name: 🔐 Generate SHA256 Checksums
        run: |
          cd "${ISO_DIR}"
          sha256sum *.iso.xz > SHA256SUMS.txt
          cat SHA256SUMS.txt

      # ---------------------------------------------------
      # 8. Bootable ISO Structure Verification
      # ---------------------------------------------------
      - name: 🧩 Verify Bootable ISO Structure
        run: |
          ISO_FILE=$(find "${ISO_DIR}" -name "*.iso.xz" | head -n 1)
          xz -d -k "$ISO_FILE"
          RAW_ISO="${ISO_FILE%.xz}"
          mkdir -p mnt
          sudo mount -o loop "$RAW_ISO" mnt
          if ! ls mnt/boot/vmlinuz-* >/dev/null 2>&1; then
            echo "❌ Kernel not found!"
            sudo umount mnt; exit 1
          fi
          if [ ! -f mnt/EFI/BOOT/BOOTX64.EFI ]; then
            echo "❌ EFI bootloader missing!"
            sudo umount mnt; exit 1
          fi
          sudo umount mnt
          echo "✅ Bootable ISO verified."

      # ---------------------------------------------------
      # 9. Upload to Google Cloud Storage
      # ---------------------------------------------------
      - name: ☁️ Upload to Google Cloud Storage
        env:
          EDITION: ${{ matrix.edition }}
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS=$PWD/gcp-key.json
          ISO_FILE=$(ls ${ISO_DIR}/*.iso.xz | head -n 1)
          SHA_FILE="${ISO_DIR}/SHA256SUMS.txt"
          ISO_NAME=$(basename "$ISO_FILE")
          VERSION_PATH="aurora/${VERSION}/${EDITION}"
          LATEST_PATH="aurora/latest/${EDITION}"
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          SHA256=$(sha256sum "$ISO_FILE" | awk '{print $1}')

          echo "🌐 Uploading to gs://${GCS_BUCKET}/${VERSION_PATH}/ ..."
          gsutil -m cp -a public-read "$ISO_FILE" "gs://${GCS_BUCKET}/${VERSION_PATH}/"
          gsutil -m cp -a public-read "$SHA_FILE" "gs://${GCS_BUCKET}/${VERSION_PATH}/"

          echo "🔁 Updating latest..."
          gsutil -m cp -a public-read "$ISO_FILE" "gs://${GCS_BUCKET}/${LATEST_PATH}/"
          gsutil -m cp -a public-read "$SHA_FILE" "gs://${GCS_BUCKET}/${LATEST_PATH}/"

          echo "🧾 Writing latest.json..."
          cat > latest.json <<EOF
          {
            "version": "${VERSION}",
            "edition": "${EDITION}",
            "release_name": "Solvionyx OS Aurora (${EDITION})",
            "tagline": "The Engine Behind the Vision.",
            "brand": "Solvionyx OS",
            "build_date": "${DATE}",
            "iso_name": "${ISO_NAME}",
            "sha256": "${SHA256}",
            "download_url": "https://storage.googleapis.com/${GCS_BUCKET}/${LATEST_PATH}/${ISO_NAME}",
            "checksum_url": "https://storage.googleapis.com/${GCS_BUCKET}/${LATEST_PATH}/SHA256SUMS.txt"
          }
          EOF
          gsutil -m cp -a public-read latest.json "gs://${GCS_BUCKET}/${LATEST_PATH}/latest.json"

      # ---------------------------------------------------
      # 10. Upload Artifact
      # ---------------------------------------------------
      - name: 📦 Upload ISO Artifact to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: Solvionyx-Aurora-${{ matrix.edition }}-${{ env.VERSION }}
          path: |
            solvionyx_build/*.iso.xz
            solvionyx_build/SHA256SUMS.txt

      # ---------------------------------------------------
      # 11. Cleanup Old Versions
      # ---------------------------------------------------
      - name: 🧹 Cleanup Old Versions (keep 5)
        env:
          EDITION: ${{ matrix.edition }}
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS=$PWD/gcp-key.json
          PREFIX="gs://${GCS_BUCKET}/aurora/"
          versions=$(gsutil ls "${PREFIX}" | grep "/v[0-9]" | sed 's#^.*/v#v#' | sort -V)
          keep=$(echo "$versions" | tail -n 5)
          remove=$(echo "$versions" | grep -vxFf <(echo "$keep") || true)
          for v in $remove; do
            echo "🗑️ Removing old version: $v"
            gsutil -m rm -r "${PREFIX}${v}/${EDITION}/" || true
          done
          echo "✅ Cleanup complete."

      # ---------------------------------------------------
      # 12. Publish GitHub Release
      # ---------------------------------------------------
      - name: 🚀 Publish GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "Aurora-${{ matrix.edition }}-${{ env.VERSION }}"
          name: "Solvionyx OS — Aurora (${{ matrix.edition }}) ${{ env.VERSION }}"
          body: |
            ## 🌌 Solvionyx OS — Aurora (${{ matrix.edition }})
            *The Engine Behind the Vision.*

            ✅ Bootable ISO (EFI + Kernel Verified)
            ✅ Uploaded to Google Cloud Storage
            ✅ GCS Bucket: solvionyx-os
            ✅ Also available as GitHub Artifact (see Actions tab)

            **Latest:**
            https://storage.googleapis.com/${{ env.GCS_BUCKET }}/aurora/latest/${{ matrix.edition }}/
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
