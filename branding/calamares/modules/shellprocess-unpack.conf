---
# Filesystem Extraction using unsquashfs (replaces broken unpackfs module)
# Extracts squashfs to @@ROOT@@ (Calamares mount point)

dontChroot: true
timeout: 600
script:
  - command: /bin/bash
    args:
      - -c
      - |
        set -e
        TARGET="@@ROOT@@"
        echo "Extracting Solvionyx OS filesystem to $TARGET"
        
        # Find squashfs
        SQUASHFS="/run/live/medium/live/filesystem.squashfs"
        if [ ! -f "$SQUASHFS" ]; then
          SQUASHFS="/lib/live/mount/medium/live/filesystem.squashfs"
        fi
        if [ ! -f "$SQUASHFS" ]; then
          echo "ERROR: Cannot find filesystem.squashfs"
          exit 1
        fi
        
        echo "Found squashfs: $SQUASHFS"
        
        # Extract with unsquashfs to Calamares mount point
        unsquashfs -f -d "$TARGET" "$SQUASHFS"
        
        # Verify extraction
        if [ ! -d "$TARGET/usr/share/zoneinfo" ]; then
          echo "ERROR: Timezone data not extracted to $TARGET"
          exit 1
        fi
        
        TZ_COUNT=$(find "$TARGET/usr/share/zoneinfo" -type f | wc -l)
        echo "✓ Filesystem extraction complete"
        echo "✓ Timezone files: $TZ_COUNT"
